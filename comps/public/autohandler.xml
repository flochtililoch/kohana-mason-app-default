<comp>
	<attr>
		<key name="_assets">array('jquery')</key>
		<key name="logged_in">NULL</key>
	</attr>
	<php>
		<![CDATA[
		
		// All is good so far
		$login_failed = FALSE;

		// Logging in via form post ?
		if(isset($_POST['action']) && $_POST['action'] === 'login')
		{
			$remember_me = isset($_POST['remember_me']) ? (bool) $_POST['remember_me'] : FALSE;

			// Log user in
			$logged_in = Auth::instance()->login($_POST['username'], $_POST['password'], $remember_me);
			
			// Defines login_failed flag only if login has actually failed (don't set it at all otherwise)
			if($logged_in === FALSE)
			{
				$login_failed = TRUE;
			}
		}
		// Logging out ?
		else if(count($this->request->param()) && in_array(I18n::instance()->uri('logout'), $this->request->param()))
		{
			Auth::instance()->logout();
			
			// Redirection done on the current address, w/o logout param in URL
			$this->request->redirect($this->request->route->uri());
		}
		else
		{
			// Set logged in flag
			$logged_in = Auth::instance()->logged_in();
		}
		
		// If user is logged in
		if($logged_in === TRUE)
		{
			$this->user = Auth::instance()->get_user();
		}
		
		$debug = FALSE;
		if(Kohana::$debug !== FALSE)
		{
			$debug['data'] = array(
				'app_environment' => Kohana::$environment,
				'app_local' => Kohana::$locale,
				'app_channel' => Kohana::$channel,
				'tree' => Kohana::$tree,
				'resources' => Kohana::$resources
				);
			$debug['json'] = Kohana::$debug === Kohana::DEBUG_JSON;
			$debug['html'] = Kohana::$debug === Kohana::DEBUG_HTML;
		}

		]]>
	</php>
	<process>
		<key name="logged_in" context="global">$logged_in</key>
		<key name="login_failed" context="global">$login_failed</key>
		<key name="debug">$debug</key>
	</process>
</comp>